name: Build, Embed Defender, and Deploy to ECR

on:
  push:
    branches:
      - main

env:
  AWS_REGION: "ap-northeast-2" 
  ECR_REPOSITORY: "hkjung-tetris-web-repo" 
  IMAGE_BASE_NAME: "tetris-web"

jobs:
  build-and-push:
    name: Build, Embed, and Push
    runs-on: ubuntu-latest
    
    permissions:
      id-token: write 
      contents: read

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Configure AWS credentials from GitHub OIDC
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_IAM_ROLE_FOR_GITHUB_ACTIONS }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      # Step 1: twistcli 다운로드 및 준비
      - name: Download and prepare twistcli
        env:
          PRISMA_CONSOLE_URL: ${{ secrets.PRISMA_CONSOLE_URL }}
          PRISMA_ACCESS_KEY: ${{ secrets.PRISMA_ACCESS_KEY }}
          PRISMA_SECRET_KEY: ${{ secrets.PRISMA_SECRET_KEY }}
        run: |
          CLEAN_URL=$(echo "$PRISMA_CONSOLE_URL" | sed 's:/*$::')
          echo "Downloading twistcli from: $CLEAN_URL"
          
          curl -k -s -L -u "$PRISMA_ACCESS_KEY:$PRISMA_SECRET_KEY" \
               "$CLEAN_URL/api/v1/util/twistcli?os=linux" -o twistcli
          
          if [ ! -s twistcli ] || head -c 10 twistcli | grep -q "<html"; then
            echo "Error: Download failed. Printing server response:"
            cat twistcli
            exit 1
          fi
          
          chmod +x twistcli
          echo "twistcli 준비 완료."

      # Step 2: Embed Defender 및 파일 추출 (경로 확인 강화)
      - name: Embed Defender and Extract
        env:
          PRISMA_CONSOLE_URL: ${{ secrets.PRISMA_CONSOLE_URL }}
          PRISMA_ACCESS_KEY: ${{ secrets.PRISMA_ACCESS_KEY }}
          PRISMA_SECRET_KEY: ${{ secrets.PRISMA_SECRET_KEY }}
        run: |
          CLEAN_URL=$(echo "$PRISMA_CONSOLE_URL" | sed 's:/*$::')
          
          echo "Embedding Defender..."
          ./twistcli app-embedded embed \
            --address "$CLEAN_URL" \
            --user "$PRISMA_ACCESS_KEY" \
            --password "$PRISMA_SECRET_KEY" \
            --app-id "${{ env.ECR_REPOSITORY }}" \
            --data-folder "/tmp" \
            Dockerfile
          
          # 1. 생성된 zip 파일 찾기 및 압축 해제
          ZIP_FILE=$(ls app_embedded_embed_*.zip)
          unzip -o "$ZIP_FILE"
          
          # 2. [매우 중요] 현재 폴더에 defender 파일이 있는지 확인
          if [ ! -f ./defender ]; then
            echo "Error: 'defender' binary not found after unzip!"
            ls -R
            exit 1
          fi
          
          # 3. 바이너리에 실행 권한 부여
          chmod +x ./defender
          echo "Defender binary is ready."

      # Step 3: 빌드 컨텍스트 확인하며 이미지 빌드
      - name: Build Protected Image
        run: |
          # zip을 풀면 'Dockerfile'이 덮어씌워졌을 것입니다. 
          # 해당 Dockerfile 안에 'COPY defender ...' 문구가 있는지 확인해봅니다.
          grep "COPY defender" Dockerfile || echo "Warning: COPY defender command not found in Dockerfile"
          
          docker build -t ${{ env.IMAGE_BASE_NAME }}:protected .

      # Step 4: Tag and push protected image to ECR
      - name: Tag and push protected image to ECR
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
        run: |
          COMMIT_HASH=$(git rev-parse --short HEAD)
          
          docker tag ${{ env.IMAGE_BASE_NAME }}:protected $ECR_REGISTRY/${{ env.ECR_REPOSITORY }}:protected-$COMMIT_HASH
          docker tag ${{ env.IMAGE_BASE_NAME }}:protected $ECR_REGISTRY/${{ env.ECR_REPOSITORY }}:latest-protected
          
          docker push $ECR_REGISTRY/${{ env.ECR_REPOSITORY }}:protected-$COMMIT_HASH
          docker push $ECR_REGISTRY/${{ env.ECR_REPOSITORY }}:latest-protected