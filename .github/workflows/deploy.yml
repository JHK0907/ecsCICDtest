name: Prisma Cloud Full Security Pipeline (Scan + Embed + Deploy)

on:
  push:
    branches:
      - main

env:
  AWS_REGION: "ap-northeast-2" 
  ECR_REPOSITORY: "hkjung-tetris-web-repo" 
  IMAGE_BASE_NAME: "tetris-web"

jobs:
  build-and-deploy:
    name: Build, Scan, and Protect
    runs-on: ubuntu-latest
    
    permissions:
      id-token: write 
      contents: read

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # 1. Checkov IaC Scan (Terraform 코드 검사)
      - name: Run Checkov IaC Scan
        env:
          PRISMA_API_URL: ${{ secrets.PRISMA_API_URL }}
          PRISMA_API_KEY: ${{ secrets.BC_API_KEY }}
        run: |
          docker run --rm \
            -e PRISMA_API_KEY="${{ env.PRISMA_API_KEY }}" \
            -e PRISMA_API_URL="${{ env.PRISMA_API_URL }}" \
            -v ${{ github.workspace }}:/app \
            bridgecrew/checkov:latest \
            --directory /app/terraform \
            --soft-fail \
            --repo-id ${{ github.repository }}

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_IAM_ROLE_FOR_GITHUB_ACTIONS }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      # 2. twistcli 다운로드 (Scan 및 Embed용)
      - name: Download twistcli
        env:
          PRISMA_CONSOLE_URL: ${{ secrets.PRISMA_CONSOLE_URL }}
          PRISMA_ACCESS_KEY: ${{ secrets.PRISMA_ACCESS_KEY }}
          PRISMA_SECRET_KEY: ${{ secrets.PRISMA_SECRET_KEY }}
        run: |
          CLEAN_URL=$(echo "$PRISMA_CONSOLE_URL" | sed 's:/*$::')
          curl -k -s -L -u "$PRISMA_ACCESS_KEY:$PRISMA_SECRET_KEY" \
               "$CLEAN_URL/api/v1/util/twistcli?os=linux" -o twistcli
          chmod +x twistcli

      # 3. 이미지 취약점 스캔용 기초 빌드
      - name: Build Base Image for Scan
        run: |
          docker build -t ${{ env.IMAGE_BASE_NAME }}:temp .

      # 4. twistcli Image Scan (이미지 취약점 검사)
      - name: Scan Image for Vulnerabilities
        env:
          PRISMA_CONSOLE_URL: ${{ secrets.PRISMA_CONSOLE_URL }}
          PRISMA_ACCESS_KEY: ${{ secrets.PRISMA_ACCESS_KEY }}
          PRISMA_SECRET_KEY: ${{ secrets.PRISMA_SECRET_KEY }}
        run: |
          CLEAN_URL=$(echo "$PRISMA_CONSOLE_URL" | sed 's:/*$::')
          ./twistcli images scan \
            --address "$CLEAN_URL" \
            --user "$PRISMA_ACCESS_KEY" \
            --password "$PRISMA_SECRET_KEY" \
            --details \
            ${{ env.IMAGE_BASE_NAME }}:temp

      # 5. Defender 주입 (App-Embedded)
      - name: Embed Defender
        env:
          PRISMA_CONSOLE_URL: ${{ secrets.PRISMA_CONSOLE_URL }}
          PRISMA_ACCESS_KEY: ${{ secrets.PRISMA_ACCESS_KEY }}
          PRISMA_SECRET_KEY: ${{ secrets.PRISMA_SECRET_KEY }}
        run: |
          CLEAN_URL=$(echo "$PRISMA_CONSOLE_URL" | sed 's:/*$::')
          ./twistcli app-embedded embed \
            --address "$CLEAN_URL" \
            --user "$PRISMA_ACCESS_KEY" \
            --password "$PRISMA_SECRET_KEY" \
            --app-id "${{ env.ECR_REPOSITORY }}" \
            --data-folder "/tmp" \
            Dockerfile
          
          ZIP_FILE=$(ls app_embedded_embed_*.zip)
          unzip -o "$ZIP_FILE"
          tar -xzvf twistlock_defender_app_embedded.tar.gz
          chmod +x ./defender

      # 6. 최종 Protected 이미지 빌드
      - name: Build Protected Image
        run: |
          sed -i '/FROM/a COPY defender /var/lib/twistlock/fargate/defender' Dockerfile
          sed -i '/COPY defender/a RUN chmod +x /var/lib/twistlock/fargate/defender' Dockerfile
          docker build -t ${{ env.IMAGE_BASE_NAME }}:protected .

      # 7. ECR Push
      - name: Push to ECR
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
        run: |
          COMMIT_HASH=$(git rev-parse --short HEAD)
          docker tag ${{ env.IMAGE_BASE_NAME }}:protected $ECR_REGISTRY/${{ env.ECR_REPOSITORY }}:protected-$COMMIT_HASH
          docker tag ${{ env.IMAGE_BASE_NAME }}:protected $ECR_REGISTRY/${{ env.ECR_REPOSITORY }}:latest-protected
          docker push $ECR_REGISTRY/${{ env.ECR_REPOSITORY }}:protected-$COMMIT_HASH
          docker push $ECR_REGISTRY/${{ env.ECR_REPOSITORY }}:latest-protected